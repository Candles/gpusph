\documentclass{../GPUSPHtemplate}

\title{GPUSPH Validation basis}

\author{}

\date{\currentver\ --- November 2018}

\begin{document}

\maketitle
\tableofcontents
\clearpage
\section{Introduction}

In the present document the various validation cases tested to check GPUSPH works as expected
are described, together with their setup in the user interface.

\section{Spheric2}


\subsection{Case Study Setup and Details}
%\vspace*{2pt}
   
\begin{itemize}
\item \textbf{Description of the Problem}: This case is based on the experimental setup of Kleefsman et al. \citep{Kleefsman}
  in their work on modeling hydraulics problems with wave impact.
  In fact, this case study has become a classic validation problem in the literature and has been reiterated multiple times,
  as can be seen in Issa and Violeau's paper \citep{SPHERIC} and in Leroy's thesis \citep{AgnesLeroy}. This case study is well
  suited for the study of strong surface deformation capabilities on an algorithm. The problem entails a model dam break
  problem with a model rigid obstacle upstream of the dam's collapse. There is no analytical solution to a problem of this type,
  so the numerical results will be compared to the measurements done by Kleefsman et al. \citep{Kleefsman}.
  Since the mathematical setup of the problem is out of the scope of this report, most variables and parameters are not non-dimensionalized except for: 
  \begin{equation}
    \begin{array}{l}
      \displaystyle{  t^{+} \doteq \frac{t}{\sqrt{L/g}} } \medskip \\ 
    \end{array}
    \end{equation}  

  \begin{figure}[h!]
    \includegraphics[scale =0.5]{../fig/SPHERIC2/SPHERIC_GEOMETRY}
    \centering
    \caption{ The 3-D geometric details of the Spheric2 case can be seen in this figure. The dimensions and the locations of the height probes can be seen here. The numbering of the fluid height sensors is from H1 to H4, as can be seen above the vertical lines in red indicating the location of the sensors.}
    \label{fig:SphericGeometry}
  \end{figure}
  
  \begin{figure}[h!]
    \includegraphics[scale =0.6]{../fig/SPHERIC2/SPHERIC_NODES}
    \centering
    \caption{ The geometric details of the obstacle used in Spheric2 can be seen in this figure. The locations of the pressure probes can be seen here. The numbering of the pressure sensors is from P1 to P8, as can be seen to the left of the crosses in red indicating the location of the sensors.}
    \label{fig:Spheric_Nodes}
  \end{figure}
  
\item \textbf{Case Setup}: This case involves the study of the deviation of numerical results from the experimental results available.
  Following Kleefsman's work, we setup numerical pressure sensors along the rigid obstacle, as can be seen in the figure \ref{fig:Spheric_Nodes}.
  We also place numerical wave height gauges, whose locations can be seen in the figure \ref{fig:SphericGeometry}.
  The geometric details can be seen in the figure \ref{fig:SphericGeometry}. Note that figures \ref{fig:SphericGeometry},
  \ref{fig:Spheric_Nodes} for this test case have been imported from Kleefsman et al. \citep{Kleefsman}.
  The experimental results contain data on the pressure variation in time along the sensors seen in figure \ref{fig:Spheric_Nodes}
  and data on the fluid height along the gauges shown in figure \ref{fig:SphericGeometry}. The analysis on the results of this
  test case will be based on a visual comparison of the numerical versus the experimental results.    
  
\item \textbf{The numerical and physical parameters studied:} The tests run for this case are designed to study the performance
  of the free surface deformation capabilities of the solver. The simulations have a fluid particle number
  of about 3 million particles. It is important to note that our numerical
  setups do not model a physical gate, and thus the dam's fluid falls instantaneouly, and this is not the case in
  Kleefsman et al.'s work. The following parameters were used for the four test cases presented in the table \ref{tab:spheric2-setup}:   
  \begin{itemize}
  \item numerical speed of sound: ${c_n} = 40 \; m/s$
  \item smoothing length to particle size ratio: $\dfrac{h}{\delta r}=1.3$ 
  \item gravity field: $g = -9.81.0 \; {m}/{s^2}$
  \item density: $\rho = 1000 \; {kg}/{m^3} $
  \item length scale: $L = 0.55 \; m$
  \item simulation time: $t^+ = 26 $
  \item particle size: $0.01m$
  \item kinematic viscosity: $\nu = 1 \times 10^{-6} (m^2/s)$
  \item whatever the density diffusion formulation, a density diffusion coefficient of 0.1
  \item with semi-analytical boundaries, a density equation based on the summation definition of the density
  \end{itemize}
  
  \begin{table}[h]\caption{Numerical tests performed on the Spheric-2 test-case}
    \label{tab:spheric2-setup}
    \begin{tabular}{ |p{3cm}|p{4cm}|p{3.5cm}|p{3cm}|  } 
      \hline
      Numerical Test & Boundary formulation & Turbulent Model & Density diffusion \\
      \hline
      Test 1 & Lennard-Jones      & none         & Colagrossi \\
      Test 2 & Lennard-Jones      & SPS          & Colagrossi \\
      Test 3 & Dynamic (3 layers) & SPS          & Colagrossi \\
      Test 4 & Semi-analytical    & $k-\epsilon$ & Brezzi \\
      \hline
    \end{tabular}
  \end{table}
\end{itemize}

\subsection{Setup in Salome}\label{sec:salome_spheric2}
For this test-case, the geometrical setup only contains the basin and the initial free-surface shape.
\begin{enumerate}
\item \textbf{Create the geometry using the Salome GEOM module}\smallskip\\
  \includegraphics[scale=0.55,trim={0cm 36.5cm 50cm 1cm}, clip]{../fig/SPHERIC2/Salome/geom_switch.png}
  \begin{itemize}
  \item Create the vertices of the basin and free-surface\\
    \textbf{New entity $\to$ Basic $\to$ Point}\smallskip\\
    \includegraphics[scale=0.4,trim={0 13cm 40cm 7cm}, clip]{../fig/SPHERIC2/Salome/vertices_creation.png}
  \item Create the lines linking the vertices together\\
    \textbf{New entity $\to$ Basic $\to$ Line}\smallskip\\
    \includegraphics[scale=0.4,trim={40cm 10cm 0cm 11cm}, clip]{../fig/SPHERIC2/Salome/lines_creation.png}
  \item Create the faces of the basin and free-surface\\
    \textbf{New entity $\to$ Build $\to$ Face}\smallskip\\
    \includegraphics[scale=0.28,trim={18cm 8cm 5cm 7cm}, clip]{../fig/SPHERIC2/Salome/faces_creation.png}
  \item Create a shell with the two faces of the free-surface\\
    \textbf{New entity $\to$ Build $\to$ Shell}\smallskip\\
    \includegraphics[scale=0.3,trim={12cm 8cm 15cm 7cm}, clip]{../fig/SPHERIC2/Salome/free_surf_shell.png}
  \item Create a shell with the faces of the basin\\
    \textbf{New entity $\to$ Build $\to$ Shell}\smallskip\\
    \includegraphics[scale=0.3,trim={12cm 7cm 15cm 8cm}, clip]{../fig/SPHERIC2/Salome/basin_shell.png}
  \item Check the normals orientation\\
    \textbf{Inspection $\to$ Normal to a face}\smallskip\\
    \includegraphics[scale=0.28,trim={12cm 7cm 12cm 8cm}, clip]{../fig/SPHERIC2/Salome/check_normals.png}
  \item For the case with dynamic boundaries, we want the layers ot be created outwards, so we need to
    create a second shell of the basin with reversed normals\\
    \textbf{Repair $\to$ Change orientation}\smallskip\\
    \includegraphics[scale=0.3,trim={12cm 7cm 15cm 8cm}, clip]{../fig/SPHERIC2/Salome/revert_normals.png}
  \end{itemize}
\item \textbf{Switch to the Particle preprocessor module to fill the domain with particles}\smallskip\\
  \includegraphics[scale=0.55,trim={0cm 36.5cm 50cm 1cm}, clip]{../fig/SPHERIC2/Salome/prepro_switch.png}
  \begin{itemize}
  \item First we have to create three cases, one for each type of boundary conditions\\
    \textbf{SPH Preprocessor $\to$ Add a case}\smallskip\\
    \includegraphics[scale=0.5,trim={0cm 26.5cm 45cm 1cm}, clip]{../fig/SPHERIC2/Salome/create_prepro_case.png}
  \item Then, define the main boundary for each case, taking care to select the basin with reversed normals for the dynamic boundaries\\
    \textbf{SPH Preprocessor $\to$ Define the main boundary}\smallskip\\
    \includegraphics[scale=0.45,trim={0cm 6cm 40cm 26.5cm}, clip]{../fig/SPHERIC2/Salome/define_main_boundary.png}
  \item Define the free-surface for the three cases\\
    \textbf{SPH Preprocessor $\to$ Define free surface}\smallskip\\
    \includegraphics[scale=0.45,trim={0cm 6cm 40cm 26.5cm}, clip]{../fig/SPHERIC2/Salome/define_free_surface.png}
  \item Edit the cases parameters, taking care to choose the corresponding boundary formulation\\
    \textbf{SPH Preprocessor $\to$ Edit filling parameters}\\
    \includegraphics[scale=0.35,trim={0cm 11cm 35cm 2cm}, clip]{../fig/SPHERIC2/Salome/edit_filling_parameters.png}
  \item Execute the preprocessor\\
    \textbf{SPH Preprocessor $\to$ Execute preprocessor}\smallskip\\
    \includegraphics[scale=0.3,trim={0cm 15cm 28cm 2cm}, clip]{../fig/SPHERIC2/Salome/execute_preprocessor.png}
  \item At this stage, it is possible to visualize the generated files by opening the corresponding vtu files in Paravis:\\
    \begin{center}\includegraphics[scale=0.3,trim={17cm 6cm 18cm 15cm}, clip]{../fig/SPHERIC2/Salome/spheric2-particles.png}\end{center}
    
    For each study, Salome creates a folder with the study name underscore presph at the same location as the hdf file.
    This is where the preprocessor files are stored: for example, let us assume that the \cmd{Spheric2.hdf} file
    is located at \cmd{$MY_STUDY_PATH/Spheric2.hdf}.
    Then, the particle files for the case with semi-analytical boundaries are located in:\\
    \cmd{$MY_STUDY_PATH/Spheric2_presph/Spheric2SA}. \\
    The files are the following:\\
    - \cmd{Spheric2SA.fluid.h5sph}:  GPUSPH file for the fluid\\
    - \cmd{Spheric2SA.basin.h5sph}: GPUSPH file for the basin\\
    - \cmd{Spheric2SA.basin.vtu}: vtu file of the basin, can be opened in Paravis\\
    - \cmd{Spheric2SA.fluid.vtu}: vtu file of the fluid, can be opened in Paravis\\
    - \cmd{basin.stl}: stl file of the basin, can be used for visualisation purposes\\
    - \cmd{basin.obj}: file for handling collisions with the basin in GPUSPH\\
    - \cmd{stl_to_obj.log}: log file of the conversion from stl to obj\\
    - \cmd{stl_to_obj.sh}: script to convert the stl file to obj format
  \end{itemize}
  
\item \textbf{Switch to the GPUSPH solver module}  \smallskip\\
  \includegraphics[scale=0.55,trim={0cm 36.5cm 50cm 1cm}, clip]{../fig/SPHERIC2/Salome/solver_switch.png}
  \begin{itemize}
  \item First we need to create four cases, one for each of the tests of the table \ref{tab:spheric2-setup}.\\
    \textbf{GPUSPH $\to$ Add a case}\smallskip\\
    \includegraphics[scale=0.45,trim={0cm 25cm 48cm 2cm}, clip]{../fig/SPHERIC2/Salome/create_solver_case.png}
  \item Define the boundaries by selecting the corresponding Particle preprocessor case and choosing the correct boundary formulation\\
    \textbf{GPUSPH $\to$ Define boundaries}\smallskip\\
    \includegraphics[scale=0.4,trim={0cm 18cm 38cm 2cm}, clip]{../fig/SPHERIC2/Salome/define_gpusph_boundaries.png}
  \item Edit the simulation parameters and set them to the ones of the table \ref{tab:spheric2-setup}.\\
    \textbf{GPUSPH $\to$ Edit simulation parameters}\smallskip\\
    \includegraphics[scale=0.4,trim={0cm 18cm 38cm 2cm}, clip]{../fig/SPHERIC2/Salome/edit_simulation_parameters.png}\medskip
  \item Now we are ready to build the case and run the simulation: right click on the case or from the GPUSPH menu:\\
    1. Generate the sources\\
    2. Build solver\\
    3. Run solver
  \item Finally, visualize the results using the Paravis module. The result files are copied into the folder
    \cmd{$MY_STUDY_PATH/Spheric2_gpusph/Spheric2SA}. While the solver is still running, they are temporarily stored in:\\
    \cmd{$MY_STUDY_PATH/Spheric2_gpusph/Spheric2SA/gpusph/dist/linux/x86_64}.
  \end{itemize}
\end{enumerate}

\subsection{Results}

The results of this case are compared with the experimental results from Kleefsman et al. \citep{Kleefsman}.
The results of the tests are in the form of pressure values recorded in time at the different sensors
and in values of fluid height at the different height sensors in time.
Figure (\ref{fig:Crash}) shows snapshots at the time $t^+=2.95$ of the simulation with semi-analytical boundaries.

%%%%%%%%%% CRASH
\begin{figure}[H]
  \begin{subfigure}[b]{0.7\linewidth}
    \centering
    \hspace*{3.3cm} \includegraphics[scale=0.45]{../fig/SPHERIC2/Nahed_results/ScaleCrash.png}
  \end{subfigure}	
  
  
  \begin{subfigure}[b]{1\linewidth}
    \centering
    \includegraphics[width=1\linewidth]{../fig/SPHERIC2/Nahed_results/CoarseCrash3.png} 
  \end{subfigure} 
  
  \caption{The image shown above is a snapshot of the Spheric2 simulation at $t^+ = 2.95 $ using semi-analytical boundaries.
    The velocities follow the color scale  seen above.}
  \label{fig:Crash}
\end{figure}
%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%Experiments 2 to 5
\begin{figure}[H]
  \centering 	
    \includegraphics[width=1\linewidth]{../fig/SPHERIC2/Nahed_results/B_P2_P5_H2_H4.png}
    \caption{This figure shows the results obtained for the Spheric2 case, with semi-analytical boundaries and the $k-\epsilon$ turbulence model.
      The data from P2 and P5, are on the top 2 sub-plots, and the data from H2 and H4 on the bottom 2 sub-plots.
      The red lines display the data as obtained from GPUSPH, while the black lines represent the experiments.}
\label{fig:TestpointsAll}
\end{figure}
%%%%%%%%%%%%%%%%%


In analyzing the tests compared against Kleefsman et al.'s experiments,
it is important to note that the simulation was run with the $k$--$\epsilon$
turbulent model turned on, which improves the results compared to a simulation without
a turbulence model since it reduces the noise, especially in the pressure signals. 
It is also noteworthy that with a finer discretisation, the results would improve significantly at all probes
and wave gages.

\section{Hydrostatic basin}

\subsection{Case Study Setup and Details}
\vspace*{2pt}
\begin{itemize}
\item \textbf{Description of the case}: We consider a simple 3-dimensional rectangular basin which is
  filled with fluid particles, and subjected to a gravity-like field force acting in a parallel and
  opposite manner with respect to the bottom's normal. The case is non-dimensionalized by using the system's scale length $L$
  and other physical parameters. The non-dimensional parameters and variables are as seen below:   
  \begin{equation}
    \begin{array}{l}
      \displaystyle{  z^{+} \doteq \frac{z}{L} } \medskip \\ 
      \displaystyle{  t^{+} \doteq \frac{t}{\sqrt{L/g}} } \medskip \\ 
      \displaystyle{  P^{+} \doteq \frac{P}{\rho gL} } \medskip \\ 
      \displaystyle{  F^{+} \doteq \frac{F}{\rho g} } 
    \end{array}
  \end{equation}  
  
\item \textbf{Case Study}:  This case involves the study of the deviation of numerical results
  from the analytical solution. The solution is based on the hydrostatic equation which can be
  derived from the RANS equation projected along the vertical z-axis: 
  
  \begin{equation}\label{eq:HydroDifferential}
    0 = F^{+}+ \frac{d P^+}{d z^+}
  \end{equation}
  
  with the differential equation being an ordinary differential equation presented as a boundary value problem.
  The wall boundaries are solid and the velocity is nullified. The resulting pressure profiles
  depend on the gravity-like force field. The chosen parameters and
  the solution to equation (\ref{eq:HydroDifferential}) are presented below.
  
  The forcing function is chosen to be: $ F^+ = \text{C}  $  
    
  \begin{equation}\label{eq:HydroStatic}
    P^+(z^+) =  -F^{+} z^+  + C
  \end{equation}
  
  The constant in equations (\ref{eq:HydroStatic}) is defined as:\\
  $C = P^+(z^+ = 0) = 1$
  
\item \textbf{The numerical and physical parameters studied:} This study sets up three tests.
  We look to study the stability of hydrostatic iterations in GPUSPH with three boundary formulations available in GPUSPH:
  Lennard-Jones, Dynamic boundaries and Semi-analytical boundaries.
  The particle size of this case is related to particle number in the case through the following representation,
  where \textit{N} is the particle number per unit
  \textit{L}\footnote{The basin's boundaries slightly reduce the expected number of particles (per unit $L$)
    along the \textit{x} and \textit{y} axes due to the fluid being constrained from multiple sides,
    as opposed to the number of particles along \textit{z}. }:
  \begin{equation}
    \delta r = \frac{L}{N} 
  \end{equation}            
  
  \begin{itemize}
  \item numerical speed of sound: ${c_n} = 40 \; m/s$
  \item smoothing length to particle size ratio: $\dfrac{h}{\delta r}=1.3$ 
  \item kinematic viscosity: $\nu = 0.05 \; {m^2}/{s}$
  \item gravity field: $g = -1.0 \; {m}/{s^2}$
  \item fluid density: $\rho = 1.0 \; {kg}/{m^3} $
  \item length scale: $L = 1.0 \; m$
  \item simulation time: $t^+ = 600 $ 
  \end{itemize}
\end{itemize}

\subsection{Setup in Salome}

The same steps for the setup can be followed as for the Spheric2 test-case (see the section \ref{sec:salome_spheric2}).

\subsection{Results}
Modeling hydrostatic phenomenon is not trivial in SPH due to the tendency of the particles
to reorder themselves at every temporal iteration, and assign to themselves small random velocities;
thus perturbing the static hypothesis required for resolving hydrostatic systems. However, with accurate
mathematical models in SPH and efficient algorithms, hydrostatic phenomena can be effectively modeled.\\
%Before GPUSPH incorporated the SA solid boundary model, hydrostatic systems almost always had issues with particle stability near a basin's wall. \\

The results of this case show GPUSPH's capacity at resolving hydrostatic phenomena. The results obtained show
both the pressure profiles at a their initial and final conditions, and the L$_2$ error's progression in time.
The L$_2$ error is important as it shows whether
GPUSPH displays converging numerical results for hydrostatic phenomena.
The results with semi-analytical boundaries are shiwn in the figures \ref{fig:HydroExp2} and \ref{fig:HydroExp2L2}.
The pressure profiles at the initial state $t^+=0$ and the final state $t^+=600$ are displayed in the figure \ref{fig:HydroExp2}.
The initial state of the particles in the basin is initialized with a hydrostatic profile, where the particles are arranged
on a Cartesian grid\footnote{As our figures are two dimensional, they do not explicity show the total
  number of particles in the basin, since most of the particles exist initially alongside each other on flat planes.
  At later time steps however, the particles rearrange and are found at different positions, as is evident
  by the plots at the final iteration.} at every $\delta r$.

Test 2 in figure (\ref{fig:HydroExp2}b) shows that the particles exhibit a deviation
in their pressure distribution, and reveals a small drift in position. The drift in vertical position
is also away from the initially defined surface at $z^+=0$ and under the initially lowest particle layer
at $z^+=0.05$. To quantify how these deviations effect the convergence of the model, the L$_2$ error, in time,
is analyzed from figure (\ref{fig:HydroExp2L2}). The results show an overall good behaviour of GPUSPH.\\

The analysis of the results of this case study show that GPUSPH is effectively capable of simulating
hydrostatic phenomena since it shows a convergent behavior. 
\vfill

\begin{figure}[H]
  \begin{subfigure}{.5\textwidth}
    \centering
    \includegraphics[trim={1.5cm 0 1.8cm 0}, clip, width=.9\linewidth]{../fig/Hydrostatic/20Particles/Pressure_20particles_Initial.png}
    \vspace*{5pt}
    \caption{Initial State}
  \end{subfigure}%
  \begin{subfigure}{.5\textwidth}
    \centering 
    \includegraphics[trim={1.5cm 0 1.8cm 0}, clip, width=.9\linewidth]{../fig/Hydrostatic/20Particles/Pressure_20particles_Final.png}
    \caption{Final State}        
  \end{subfigure}
  \caption{Hydrostatic basin case: numerical and theoretical pressure profiles along the basin's height.
    The initial profile at $t^+=0$ is seen at the top and with the final pressure profile at $t^+=600$ in the image just under.
    The results are for semi-analytical boundaries. It is important to note that the theoretical profile is
    based on the initial distribution of the particles and thus extends from the particles at the surface of the
    basin at $z^+=1$ to the bottom particle's postion at a distance $\delta r = 0.05 $ from the floor at $z^+=0$. }
  \label{fig:HydroExp2}
\end{figure}

\begin{figure}[H]
  \centering
  \includegraphics[scale=0.6]{../fig/Hydrostatic/20Particles/L2_Hydrostatic20Part.png}
  \caption{The plot seen above represents the L$_2$ error as it progresses in time for test 2 of section 2.2.1, where we note the decreasing trend of the error in time. The data is presented as a semi-log plot. }
  \label{fig:HydroExp2L2}
\end{figure}

\bibliography{../gpusph-manual.bib}

\end{document}

